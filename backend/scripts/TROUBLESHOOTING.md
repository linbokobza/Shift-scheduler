# 🔧 מדריך פתרון בעיות - אלגוריתם שיבוץ משמרות

## 📋 תוכן עניינים
1. [בעיות נפוצות](#בעיות-נפוצות)
2. [איך לקרוא את ה-Debug Logs](#איך-לקרוא-את-ה-debug-logs)
3. [פתרונות לבעיות ספציפיות](#פתרונות-לבעיות-ספציפיות)
4. [בדיקות ווידוא](#בדיקות-ווידוא)

---

## ❌ בעיות נפוצות

### 1. משמרות נשארות ריקות למרות שיש עובדים

**תסמינים:**
- בסידור יש תאים ריקים (null)
- בקונסול: `⚠️ WARNING: X shifts were left UNFILLED`

**סיבות אפשריות:**

#### א. אף עובד לא זמין למשמרת זו
```
👥 Employee Availability Summary:
   Alice: 12/16 shifts available
   Bob: 10/16 shifts available
   Charlie: 8/16 shifts available
```
**פתרון:** בדקי באיזה משמרות אף אחד לא זמין. בקשי מהעובדים להגדיל זמינות.

#### ב. האילוצים מונעים שיבוץ
דוגמה: עובד A זמין לבוקר, אבל עבד לילה אתמול → אסור בוקר אחרי לילה!

**פתרון:** הרצי מחדש את האלגוריתם (מנסה סדר שונה), או הוסיפי עוד עובדים זמינים.

#### ג. הגדרת זמינות שגויה
עובד סימן בטעות "לא זמין" במקום "זמין".

**פתרון:**
1. בדקי את ההגשות בממשק "צפייה בהגשות"
2. תקני זמינויות שגויות
3. צרי סידור מחדש

---

### 2. חגים לא מופעלים / משמרות נוצרות בחגים

**תסמינים:**
- בחג יש משמרות ערב/לילה (כשצריך רק בוקר)
- בחג "ללא עבודה" יש משמרות

**איך לבדוק:**
הסתכלי בקונסול Backend על:
```
📅 Loaded X holidays:
   2025-11-19: חנוכה - Type: morning-only
```

**אם רואים: `⚠️ No holidays loaded!`**

**סיבות:**
1. **החג לא הוגדר במערכת**
   - פתרון: הוסיפי את החג דרך "ניהול חגים"

2. **התאריך שגוי**
   - דוגמה: החג ב-19.11 אבל הוגדר ב-20.11
   - פתרון: מחקי והוסיפי מחדש עם התאריך הנכון

3. **פורמט תאריך לא תקין**
   - החג צריך להיות בפורמט: `YYYY-MM-DD` (לדוגמה: `2025-11-19`)
   - פתרון: ודאי שהתאריך בפורמט נכון

**אם רואים את החג אבל עדיין יש משמרות:**
```
🎉 Day 3 (2025-11-19) has holiday: חנוכה (type: morning-only)
   ⏭️ Skipping day 3 (2025-11-19) evening: morning-only holiday
   ⏭️ Skipping day 3 (2025-11-19) night: morning-only holiday
```

זה **תקין!** המשמרות מסוננות נכון.

אם **לא רואים** את השורות "Skipping" - יש באג בקוד.

---

### 3. עובד מקבל יותר מדי משמרות / חוסר הוגנות

**תסמינים:**
- עובד A קיבל 6 משמרות, עובד B קיבל 2 משמרות
- `Fairness gap: 4`

**סיבות:**

#### א. עובד B הגיש מעט זמינויות
```
👥 Employee Availability Summary:
   Alice: 14/16 shifts available
   Bob: 4/16 shifts available  ← בעיה!
```

**פתרון:** בקשי מעובד B להגיש יותר זמינויות.

#### ב. עובד B לא זמין בזמנים קריטיים
עובד B זמין רק ללילות, אבל כל הלילות כבר תפוסים.

**פתרון:** בקשי ממנו להיות זמין גם לבוקרים/ערבים.

---

### 4. עובד לא קיבל משמרת בוקר

**תסמינים:**
- `⚠️ העובד X לא קיבל משמרת בוקר`
- `No morning: 1` בסטטיסטיקות

**סיבות:**

#### א. העובד לא סימן אף בוקר כזמין
```
👥 Employee Availability Summary:
   Charlie: 8/16 shifts available
```
אבל כל ה-8 הן ערבים ולילות בלבד!

**פתרון:** בקשי מהעובד לסמן לפחות בוקר אחד כזמין.

#### ב. כל הבקרים תפוסים
עובדים אחרים תפסו את כל הבקרים לפניו.

**פתרון:** הרצי מחדש (ינסה סדר אחר), או הוסיפי עוד עובדים.

---

### 5. משמרות 8-8 (ערב→בוקר / לילה→ערב)

**תסמינים:**
- `Excess 8-8 (>1): 2` - יותר מ-1 לעובד
- `⚠️ העובד X קיבל 2 משמרות 8-8`

**הסבר:**
האלגוריתם **מנסה** להימנע ממשמרות 8-8, אבל אם אין ברירה (כל האילוצים האחרים חשובים יותר), הוא ייצור אותן.

**פתרון:**
1. **הוסיפי עוד עובדים** - יותר גמישות
2. **הגדילי זמינויות** - יותר אופציות
3. **אם זה קורה לעיתים רחוקות** - זה OK! זה soft constraint

---

### 6. משמרות 8-8-8 (3 משמרות רצופות)

**תסמינים:**
- `8-8-8 violations: 1`
- עובד עבד: לילה (יום א') → ערב (יום ב') → בוקר (יום ג')

**הסבר:**
זה **חמור יותר** מ-8-8 רגיל. האלגוריתם נותן לזה קנס גבוה (100,000) אבל לא חוסם לחלוטין.

**פתרון:**
1. **הוסיפי עוד עובדים** (פתרון עיקרי)
2. **בדקי זמינויות** - אולי עובד מסוים תקוע בתבנית הזו
3. **אם זה קורה לעיתים נדירות מאוד** - זה עדיין עדיף על משמרת ריקה

---

## 🔍 איך לקרוא את ה-Debug Logs

כשאתה יוצרת סידור, הקונסול של Backend מדפיס מידע מפורט:

### שלב 1: טעינת נתונים
```
✓ Received input: 5 employees, week 2025-11-16
```

### שלב 2: חגים
```
📅 Loaded 2 holidays:
   2025-11-19: חנוכה - Type: morning-only
   2025-11-22: שבת - Type: no-work
```

**מה לבדוק:**
- ✅ מספר החגים נכון?
- ✅ התאריכים נכונים?
- ✅ הסוג נכון? (`no-work` או `morning-only`)

### שלב 3: סינון משמרות
```
🎉 Day 3 (2025-11-19) has holiday: חנוכה (type: morning-only)
   ⏭️  Skipping day 3 (2025-11-19) evening: morning-only holiday
   ⏭️  Skipping day 3 (2025-11-19) night: morning-only holiday
   ⏭️  Skipping day 5 (2025-11-21) evening: Friday (only morning allowed)
   ⏭️  Skipping day 5 (2025-11-21) night: Friday (only morning allowed)
✅ Created 11 valid shifts
```

**מה לבדוק:**
- ✅ משמרות נכונות מסוננות?
- ✅ שישי רק בוקר? ✅
- ✅ חגי "no-work" מסוננים לגמרי? ✅

### שלב 4: זמינות עובדים
```
👥 Employee Availability Summary:
   Alice: 10/11 shifts available
   Bob: 11/11 shifts available
   Charlie: 8/11 shifts available
   Diana: 9/11 shifts available
   Eve: 11/11 shifts available
```

**מה לבדוק:**
- ✅ כל עובד זמין ל-**לפחות 3** משמרות?
- ⚠️ אם עובד זמין לפחות מ-30% מהמשמרות - **זו בעיה!**

### שלב 5: פתרון
```
✓ Solving with CP-SAT...
✓ Solution found! Status: OPTIMAL
  Objective value: 0.0
  Unfilled shifts: 0
  8-8-8 violations: 0
  Excess 8-8 (>1): 0
  No morning: 0
  Fairness gap: 1

✅ All shifts successfully filled!
```

**מה לבדוק:**
- ✅ `Status: OPTIMAL` - פתרון מושלם!
- ✅ `Unfilled shifts: 0` - כל המשמרות מאוישות
- ✅ `Fairness gap: 0-1` - הוגנות מעולה
- ⚠️ `Fairness gap: 2-3` - סביר
- ❌ `Fairness gap: 4+` - בעייתי

---

## ✅ בדיקות ווידוא

### בדיקה 1: ודאי שהחגים מוגדרים
1. התחברי כמנהל
2. לכי ל"ניהול חגים" בתפריט
3. ודאי שכל החגים של החודש מוגדרים עם:
   - תאריך נכון (פורמט `YYYY-MM-DD`)
   - שם ברור
   - סוג נכון (`no-work` או `morning-only`)

### בדיקה 2: ודאי שיש מספיק זמינויות
1. לכי ל"צפייה בהגשות"
2. ספרי כמה עובדים הגישו לשבוע הנוכחי
3. ודאי שלפחות **70%** מהמשמרות יש לפחות **2 עובדים זמינים**

### בדיקה 3: הפעלי את האלגוריתם
1. לחצי "צור סידור"
2. פתחי את Console בדפדפן (F12)
3. עברי למסך "Backend logs" (אם יש)
4. חפשי:
   - ✅ `All shifts successfully filled!`
   - ✅ `Objective value: 0.0` או קרוב
   - ⚠️ אזהרות (אם יש)

### בדיקה 4: בדקי את הסידור
1. ודאי שאין תאים ריקים (אלא אם אף אחד לא זמין)
2. ודאי שבחגים אין משמרות
3. ודאי שבשישי יש רק בוקר
4. ודאי שכל עובד קיבל לפחות 3 משמרות (אם אפשר)
5. ודאי שכל עובד קיבל לפחות בוקר אחד

---

## 🆘 צריכה עזרה נוספת?

### בעיות שלא מופיעות כאן:

1. **הדפיסי את כל ה-logs** מהקונסול
2. **צלמי screenshot** של הסידור הבעייתי
3. **שתפי** עם המפתח:
   - כמה עובדים?
   - כמה משמרות?
   - מה האזהרות שהופיעו?
   - מה התוצאה שקיבלת vs. מה ציפית?

### דיבוג מתקדם:

אם אתה מפתח ורוצה לחקור עמוק יותר:

```bash
# הרצת הסולבר ישירות עם נתונים
cd backend/scripts
cat your_data.json | python optimize_schedule.py 2>&1 | tee debug.log
```

זה ישמור את כל ה-logs בקובץ `debug.log` לניתוח.

---

## 📚 מסמכים נוספים

- [`README.md`](README.md) - תיעוד כללי על האלגוריתם
- [`../TEST_SETUP.md`](../../TEST_SETUP.md) - מדריך בדיקה והתקנה
- [`optimize_schedule.py`](optimize_schedule.py) - קוד המקור

---

**עדכון אחרון:** נובמבר 2025
**גרסה:** 2.0 (עם OR-Tools CP-SAT)
